<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>สมุดลงทะเบียน2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.2.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css" rel="stylesheet">
  <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>
<body>
  <div class="container py-5">
    <div class="text-center">
      <h2>สมุดลงทะเบียน</h2>
      <p class="lead">กรุณากรอกข้อมูล</p>
    </div>

    <div class="row">
      <div class="col-md-5">
        <div>โหมด: <span id="mode">เพิ่ม</span></div>
        <input type="hidden" id="dataId">

        <div class="mb-3">
          <label>ชื่อ-สกุล</label>
          <input type="text" id="name" class="form-control">
        </div>

        <div class="mb-3">
          <label>แผนก</label>
          <select id="department" class="form-select">
            <option value="">เลือก...</option>
            <option value="Dev">Dev</option>
            <option value="Engineer">Engineer</option>
            <option value="Hr">Hr</option>
          </select>
        </div>

        <div class="d-grid gap-2 d-md-block">
          <button onclick="addData()" class="btn btn-primary">เพิ่ม</button>
          <button onclick="updateData()" class="btn btn-warning">อัพเดท</button>
          <button onclick="resetForm()" class="btn btn-secondary">รีเซ็ต</button>
        </div>
      </div>

      <div class="col-md-7">
        <table id="my_table" class="display" style="width:100%"></table>
      </div>
    </div>
  </div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbzS1DFFmuchGo8Wd17pSmdeUuDsZeJNjKPnNGxYD1I7AbfhODK-gjHaWChZb9CkeQSa/exec"; // ใส่ URL ของคุณ

function addData() {
  let name = $("#name").val();
  let department = $("#department").val();
  fetch(webAppUrl, {
    method: "POST",
    body: new URLSearchParams({
      action: "addDataValue",
      name: name,
      department: department
    })
  })
  .then(res => res.text())
  .then(res => {
    console.log(res);
    resetForm();
    readData();
  });
}

function readData() {
  fetch(webAppUrl, {
    method: "POST",
    body: new URLSearchParams({
      action: "readDataValue"
    })
  })
  .then(res => res.json())
  .then(data => {
    $('#my_table').DataTable({
      data: data,
      destroy: true,
      columns: [
        { title: "เวลา", render: data => moment(data).format("DD/MM/YYYY HH:mm:ss") },
        { title: "ID" },
        { title: "ชื่อ" },
        { title: "แผนก" },
        { title: "แก้ไข", render: () => `<button onclick="editData(this)" class="btn btn-sm btn-info">แก้ไข</button>` },
        { title: "ลบ", render: () => `<button onclick="removeData(this)" class="btn btn-sm btn-danger">ลบ</button>` }
      ]
    });
  });
}

function editData(ele) {
  let dataId = $(ele).closest('tr').find('td:nth-child(2)').text();
  fetch(webAppUrl, {
    method: "POST",
    body: new URLSearchParams({
      action: "getDataValue",
      dataId: dataId
    })
  })
  .then(res => res.json())
  .then(data => {
    $("#dataId").val(data[1]);
    $("#name").val(data[2]);
    $("#department").val(data[3]);
    $("#mode").text("แก้ไข: " + data[1]);
  });
}

function updateData() {
  let dataId = $("#dataId").val();
  let name = $("#name").val();
  let department = $("#department").val();
  fetch(webAppUrl, {
    method: "POST",
    body: new URLSearchParams({
      action: "updateDataValue",
      dataId: dataId,
      name: name,
      department: department
    })
  })
  .then(res => res.text())
  .then(res => {
    console.log(res);
    resetForm();
    readData();
  });
}

function removeData(ele) {
  let dataId = $(ele).closest('tr').find('td:nth-child(2)').text();
  fetch(webAppUrl, {
    method: "POST",
    body: new URLSearchParams({
      action: "removeDataValue",
      dataId: dataId
    })
  })
  .then(res => res.text())
  .then(res => {
    console.log(res);
    readData();
  });
}

function resetForm() {
  $("#name").val("");
  $("#department").val("");
  $("#dataId").val("");
  $("#mode").text("เพิ่ม");
}

document.addEventListener('DOMContentLoaded', function() {
  readData();
});
</script>
</body>
</html>
